{"version":3,"file":"data-privacy-compliance.js","sources":["../src/lib/cookie.js","../src/frameworks/base.js","../src/frameworks/ccpa_on_chorus.js","../src/frameworks/ccpa_from_us_privacy_string.js","../src/frameworks/us_privacy_string_and_api_generator.js","../src/frameworks/index.js","../src/privacy_compliance.js"],"sourcesContent":["/**\n * Gets all the cookies as a Map\n *\n * @returns Map of cookie values\n */\nfunction getAllCookies() {\n  return new Map(document.cookie.split(';').map(cookie => cookie.trim().split('=')));\n}\n\n/**\n * Checks if cookie exists\n *\n * @param {String} name name of cookie\n * @return {Boolean} true of cookie is present\n */\nfunction hasCookie(name) {\n  return getAllCookies().has(name);\n}\n\n/**\n * Gets the cookie value\n *\n * @param {String} name name of cookie\n * @return {String} the value of the cookie\n */\nfunction getCookie(name) {\n  return getAllCookies().get(name);\n}\n\nmodule.exports = {\n  getAllCookies,\n  hasCookie,\n  getCookie,\n};\n","class FrameworkBase {\n  constructor() {\n    this.privacyComplianceInstance = null;\n  }\n\n  static isAutoLoaded() {\n    return true;\n  }\n\n  name() {\n    return 'FrameworkBase';\n  }\n\n  isApplicable() {\n    return true;\n  }\n\n  useConfig(someConfigs = {}) {}\n\n  supportedCapabilities() {\n    return [];\n  }\n\n  supportedGenerators() {\n    return [];\n  }\n\n  canAnswerCapability(capability) {\n    return this.supportedCapabilities().includes(capability);\n  }\n\n  canGenerate(ability) {\n    return this.supportedGenerators().includes(ability);\n  }\n\n  setPrivacyComplianceInstance(pc) {\n    this.privacyComplianceInstance = pc;\n  }\n\n  log(...args) {\n    this.privacyComplianceInstance && this.privacyComplianceInstance.log(`[${this.name()}]`, ...args);\n  }\n}\n\nmodule.exports = FrameworkBase;\n","const Cookie = require('../lib/cookie');\nconst FrameworkBase = require('./base');\n\nclass CcpaOnChorus extends FrameworkBase {\n  name() {\n    return 'CcpaOnChorus';\n  }\n\n  isApplicable() {\n    return !!window && !!window.Chorus;\n  }\n\n  supportedCapabilities() {\n    return ['canUsePersonalInformationForTargeting', 'hasBeenNotifiedOfRights', 'isLSPACoveredTransaction'];\n  }\n\n  canUsePersonalInformationForTargeting() {\n    return !Cookie.hasCookie('_chorus_ccpa_consent_donotsell');\n  }\n\n  hasBeenNotifiedOfRights() {\n    // see https://github.com/voxmedia/sbn/commit/ce74ab006c89afe799afffa2a31137454d9e5bb3\n    return Cookie.hasCookie('_chorus_ccpa_consent');\n  }\n\n  isLSPACoveredTransaction() {\n    return true;\n  }\n}\n\nmodule.exports = CcpaOnChorus;\n","const FrameworkBase = require('./base');\n\n/**\n * Implements usprivacy string framework\n * for more information on the US Privacy string see:\n * https://github.com/InteractiveAdvertisingBureau/USPrivacy/blob/master/CCPA/US%20Privacy%20String.md#us-privacy-string-format\n */\nclass CCPAFromUSPrivacyString extends FrameworkBase {\n  constructor() {\n    super();\n    this.usPrivacyString = '';\n  }\n\n  name() {\n    return 'CCPAFromUSPrivacyString';\n  }\n\n  useConfig({ usp }) {\n    if (usp) {\n      this.usPrivacyString = ('' + usp).toUpperCase();\n    }\n  }\n\n  isApplicable() {\n    return !!this.usPrivacyString;\n  }\n\n  supportedCapabilities() {\n    return ['canUsePersonalInformationForTargeting', 'hasBeenNotifiedOfRights', 'isLSPACoveredTransaction'];\n  }\n\n  canUsePersonalInformationForTargeting() {\n    return this.consentStringAllowsPersonalDataSale();\n  }\n\n  hasBeenNotifiedOfRights() {\n    return this.consentStringAcknowledgesUserHasBeenNotifiedOfRights();\n  }\n\n  consentStringAllowsPersonalDataSale() {\n    if (!this.supportedUsPrivacyStringVersion()) return true;\n    if (!this.consentStringAcknowledgesUserHasBeenNotifiedOfRights()) return true;\n    return this.usPrivacyString[2] !== 'Y';\n  }\n\n  isLSPACoveredTransaction() {\n    return this.supportedUsPrivacyStringVersion() && this.usPrivacyString[3] === 'Y';\n  }\n\n  consentStringAcknowledgesUserHasBeenNotifiedOfRights() {\n    return this.supportedUsPrivacyStringVersion() && this.usPrivacyString[1] === 'Y';\n  }\n\n  supportedUsPrivacyStringVersion() {\n    return this.usPrivacyString.length === 4 && this.usPrivacyString[0] === '1';\n  }\n}\n\nmodule.exports = CCPAFromUSPrivacyString;\n","const FrameworkBase = require('./base');\n\nconst US_PRIVACY_API_VERSION = 1;\n\n/**\n * Implements usprivacy string framework\n * for more information on the US Privacy string see:\n * https://github.com/InteractiveAdvertisingBureau/USPrivacy/blob/master/CCPA/US%20Privacy%20String.md#us-privacy-string-format\n */\nclass UsPrivacyStringAndAPIGenerator extends FrameworkBase {\n  constructor() {\n    super();\n    this.window = window;\n    this.document = document;\n  }\n\n  name() {\n    return 'UsPrivacyStringAndAPIGenerator';\n  }\n\n  supportedGenerators() {\n    return ['usPrivacyString', 'installPrivacyAPI'];\n  }\n\n  useConfig({ window, document }) {\n    this.window = window;\n    this.document = document;\n  }\n\n  usPrivacyString(callback = () => {}) {\n    callback(this.buildUsPrivacyString(), this);\n  }\n\n  installPrivacyAPI(callback = () => {}) {\n    this.window.__uspapi = this.handleUSPrivacyAPI.bind(this);\n    this.createUspapiFrame();\n    callback(true);\n  }\n\n  // Private methods ---------\n  buildUsPrivacyString() {\n    let usp = '' + US_PRIVACY_API_VERSION;\n    usp += this.privacyComplianceInstance.hasBeenNotifiedOfRights() ? 'Y' : 'N';\n    usp += this.privacyComplianceInstance.canUsePersonalInformationForTargeting() ? 'N' : 'Y';\n    usp += this.privacyComplianceInstance.isLSPACoveredTransaction() ? 'Y' : 'N';\n    return usp;\n  }\n\n  handleUSPrivacyAPI(command, version, callback) {\n    if (typeof callback !== 'function') {\n      throw `__uspapi: Expected ${callback} to be a function, received a ${typeof callback}`;\n    }\n\n    let canSuccessfullyAnswer = true;\n    let usPrivacyDataString = `${US_PRIVACY_API_VERSION}---`;\n\n    if (version !== US_PRIVACY_API_VERSION) {\n      console.error(`__uspapi: Only able to handle version 1`);\n      canSuccessfullyAnswer = false;\n    }\n\n    switch (command) {\n      case 'getUSPData':\n        usPrivacyDataString = this.buildUsPrivacyString();\n        break;\n      default:\n        canSuccessfullyAnswer = false;\n        console.error(`__uspapi: Unable to handle command '${command}'`);\n    }\n\n    this.log(\n      `${canSuccessfullyAnswer ? 'Successfully' : 'Unsuccessfully'} handled CCPA privacy request ${usPrivacyDataString}`\n    );\n\n    callback(\n      {\n        uspString: usPrivacyDataString,\n        version: US_PRIVACY_API_VERSION,\n      },\n      canSuccessfullyAnswer\n    );\n  }\n\n  /**\n   * Creates a top level iframe used to proxy messages between\n   * frames and this implementation of the CCPA Compliance Framework\n   *\n   * It works by:\n   *   1. Creating a specially named iframe\n   *   2. Setting up an event listener on this frame\n   *   3. This listener will proxy \"__uspapiCall\" messages to handleUSPrivacyAPI\n   *   4. and post the message back to the sending frame.\n   */\n  createUspapiFrame() {\n    this.log('Creating __uspapiLocator iframe');\n\n    const frame = this.document.createElement('iframe');\n    frame.setAttribute('name', '__uspapiLocator');\n    frame.style.display = 'none';\n\n    if (this.document.readyState === 'loading') {\n      this.document.addEventListener('DOMContentLoaded', () => {\n        this.document.body.appendChild(frame);\n        this.setupIframeMessageProxyOn(frame);\n      });\n    } else {\n      this.document.body.appendChild(frame);\n      this.setupIframeMessageProxyOn(frame);\n    }\n  }\n\n  /**\n   * Will setup listener proxy on the iframe which... accomplish 2-4 from above\n   *\n   *   2. Setting up an event listener on this frame\n   *   3. This listener will proxy \"__uspapiCall\" messages to handleUSPrivacyAPI\n   *   4. and post the message back to the sending frame.\n   *\n   * @param {DOMElement} frame the iframe to setup the listener on\n   */\n  setupIframeMessageProxyOn(frame) {\n    frame.contentWindow.addEventListener('message', event => {\n      const messageData = event.data;\n\n      if (messageData && messageData.__uspapiCall) {\n        this.log('__uspapiLocator responding to message request');\n\n        const uspapiCallParameters = messageData.__uspapiCall;\n        const targetSource = event.source || window.top;\n        const targetOrigin = event.origin || '*';\n\n        this.handleUSPrivacyAPI(\n          uspapiCallParameters.command,\n          uspapiCallParameters.version,\n          (uspData, wasSuccessful) => {\n            targetSource.postMessage(\n              {\n                __uspapiReturn: {\n                  returnValue: uspData,\n                  success: wasSuccessful,\n                  callId: uspapiCallParameters.callId,\n                },\n              },\n              targetOrigin\n            );\n          }\n        );\n      }\n    });\n  }\n}\n\nmodule.exports = UsPrivacyStringAndAPIGenerator;\n","const CcpaOnChorus = require('./ccpa_on_chorus');\nconst CcpaFromUsPrivacyString = require('./ccpa_from_us_privacy_string');\nconst UsPrivacyStringAndAPIGenerator = require('./us_privacy_string_and_api_generator');\n\nmodule.exports = [CcpaOnChorus, CcpaFromUsPrivacyString, UsPrivacyStringAndAPIGenerator];\n","const frameworks = require('./frameworks');\n\n/**\n * The public Privacy Compliance class, which is exported as a singleton\n *\n * Responsible for managing frameworks and proxying requests to related\n * frameworks.\n *\n * Note: This uses Proxy() to support introspection of method calls\n * to make it look like this class has a lot more functions\n * than it really does\n */\nclass PrivacyCompliance {\n  constructor() {\n    this.frameworks = [];\n    this.supportedCapabilities = new Set();\n    this.supportedGenerators = new Set();\n    this.logEntries = [];\n    this.logger = (...args) => {\n      this.logEntries.push(args);\n    };\n  }\n\n  /**\n   * useConfig is a convenient way to pass configuration values to all frameworks.\n   * When a useConfig is called, every loaded framework will have their own\n   * useConfig methods called.\n   *\n   * The ideal pattern is to use keys to type the configs, for example:\n   * PrivacyCompliance.useConfig({\n   *   usp: \"1TFT\"\n   * })\n   * Which could signal to any listening capabiltiy-frameworks to use the new\n   * US Privacy String\n   *\n   * @param {Object} someConfigs any config to share with all frameworks\n   */\n  useConfig(someConfigs) {\n    this.frameworks.forEach(f => f.useConfig(someConfigs));\n  }\n\n  /**\n   * Allows this libraries internal logs to be accessible to including libraries.\n   * The default is to also insert any missed logs. Because this is setup as a singleton,\n   * it is easy to miss the initial setup logs, that happened, before a logger was setup.\n   *\n   * @param {Function} logFunction to be called everytime a new log entry is generated\n   * @param {Boolean} relogMissedEntries when true will relog missed entries from before the logger was wired up\n   */\n  useLogger(logFunction, relogMissedEntries = true) {\n    this.logger = logFunction;\n    if (relogMissedEntries) {\n      this.logEntries.forEach(entry => this.log(...entry));\n    }\n  }\n\n  addFramework(frameworkInstance) {\n    this.log('Adding new framework: ', frameworkInstance.name());\n    frameworkInstance.setPrivacyComplianceInstance(privacyComplianceSingleton);\n    this.frameworks.push(frameworkInstance);\n    frameworkInstance.supportedCapabilities().forEach(c => this.supportedCapabilities.add(c));\n    frameworkInstance.supportedGenerators().forEach(c => this.supportedGenerators.add(c));\n  }\n\n  /**\n   * Checks if a given Capability (as a string) can be answered by the loaded\n   * frameworks.\n   *\n   * Caution: not all frameworks will be applicable and able to\n   * answer this capability for all environments.\n   *\n   * @param {String} capability the method name of the capability\n   * @returns Boolean true if the capability can be answered\n   */\n  hasFrameworkLoadedToAnswerCapability(capability) {\n    return this.supportedCapabilities.has(capability);\n  }\n\n  canGenerate(ability) {\n    return this.supportedGenerators.has(ability);\n  }\n\n  /**\n   * Returns a list of applicable frameworks for this environment.\n   */\n  applicableFrameworks() {\n    return this.frameworks.filter(f => f.isApplicable());\n  }\n\n  log(...args) {\n    this.logger(...args);\n  }\n\n  get Generator() {\n    return new Proxy(this, {\n      get: (privacyComplianceInstance, property) => {\n        return privacyComplianceInstance.proxyToFrameworkGenerators(property);\n      },\n    });\n  }\n\n  // For use with testing only\n  reset() {\n    this.frameworks = [];\n    this.supportedCapabilities = new Set();\n    this.supportedGenerators = new Set();\n  }\n\n  /**\n   * This method will take a string, translate it into a method and call it\n   * on the added frameworks. If all applicable frameworks support this capability\n   * then it will return true, if not it will be false.\n   *\n   * @param {String} methodName the name of methods to call on the base frameworks\n   * @return Boolean if all the frameworks permit this\n   */\n  proxyToFrameworks(methodName) {\n    try {\n      return this.frameworks\n        .filter(f => f.isApplicable())\n        .filter(f => f.canAnswerCapability(methodName))\n        .map(f => {\n          this.log(f.name() + ' answering: ' + methodName);\n          return f;\n        })\n        .map(f => f[methodName].call(f))\n        .every(result => !!result);\n    } catch (e) {\n      console.error(`There was an error calling ${methodName} - ${e}`);\n    }\n  }\n\n  /**\n   * This method will take a string, translate it into a method and call it\n   * on the added frameworks. If all applicable frameworks support this generator\n   * then it will be called, with the given passback.\n   *\n   * Note this is a little more complex than capabilities, because like capabilities\n   * multiple frameworks can be called for this generator, and there is no convenient way\n   * to collect those responses, so instead it takes a callback that will be executed for\n   * every generator run.\n   *\n   * @param {String} methodName the name of methods to call on the base frameworks\n   * @returns {Function} the function to execute, with callback of the generators response\n   */\n  proxyToFrameworkGenerators(methodName) {\n    if (this.canGenerate(methodName)) {\n      return (callback = () => {}) => {\n        try {\n          this.frameworks\n            .filter(f => f.isApplicable())\n            .filter(f => f.canGenerate(methodName))\n            .forEach(f => f[methodName].call(f, callback));\n        } catch (e) {\n          console.error(`There was an error calling ${methodName} - ${e}`);\n        }\n      };\n    } else {\n      this.throwUnsupportedError(methodName);\n    }\n  }\n\n  throwUnsupportedError(method) {\n    throw new TypeError(\n      `Can not call '${method}'. It is not found in the loaded frameworks. Supported capabilities: ${Array.from(\n        this.supportedCapabilities\n      ).join(', ')}`\n    );\n  }\n\n  /**\n   * This uses a modern Proxy() object to support arbitrary missing methods\n   * which allows the frameworks to declare their own capability methods without\n   * needing to add those to this class.\n   */\n\n  applyProxy() {\n    return new Proxy(this, {\n      get: (privacyComplianceInstance, property) => {\n        if (Reflect.has(privacyComplianceInstance, property)) {\n          return Reflect.get(privacyComplianceInstance, property);\n        } else if (privacyComplianceInstance.hasFrameworkLoadedToAnswerCapability(property)) {\n          return () => {\n            return privacyComplianceInstance.proxyToFrameworks(property);\n          };\n        } else {\n          privacyComplianceInstance.throwUnsupportedError(property);\n        }\n      },\n    });\n  }\n}\n\nconst privacyComplianceSingleton = new PrivacyCompliance().applyProxy();\n\n// Autoload all of the auto-loaded frameworks\nframeworks\n  .filter(f => f.isAutoLoaded())\n  .forEach(f => {\n    privacyComplianceSingleton.addFramework(new f());\n  });\n\nmodule.exports = privacyComplianceSingleton;\n"],"names":["getAllCookies","Map","document","cookie","split","map","trim","hasCookie","name","has","getCookie","get","FrameworkBase","privacyComplianceInstance","capability","supportedCapabilities","includes","ability","supportedGenerators","pc","args","log","CcpaOnChorus","window","Chorus","Cookie","CCPAFromUSPrivacyString","usPrivacyString","usp","toUpperCase","consentStringAllowsPersonalDataSale","consentStringAcknowledgesUserHasBeenNotifiedOfRights","supportedUsPrivacyStringVersion","length","US_PRIVACY_API_VERSION","UsPrivacyStringAndAPIGenerator","callback","buildUsPrivacyString","__uspapi","handleUSPrivacyAPI","bind","createUspapiFrame","hasBeenNotifiedOfRights","canUsePersonalInformationForTargeting","isLSPACoveredTransaction","command","version","canSuccessfullyAnswer","usPrivacyDataString","console","error","uspString","frame","createElement","setAttribute","style","display","readyState","addEventListener","body","appendChild","setupIframeMessageProxyOn","contentWindow","event","messageData","data","__uspapiCall","uspapiCallParameters","targetSource","source","top","targetOrigin","origin","uspData","wasSuccessful","postMessage","__uspapiReturn","returnValue","success","callId","CcpaFromUsPrivacyString","PrivacyCompliance","frameworks","Set","logEntries","logger","push","someConfigs","forEach","f","useConfig","logFunction","relogMissedEntries","entry","frameworkInstance","setPrivacyComplianceInstance","privacyComplianceSingleton","c","add","filter","isApplicable","methodName","canAnswerCapability","call","every","result","e","canGenerate","throwUnsupportedError","method","TypeError","Array","from","join","Proxy","property","Reflect","hasFrameworkLoadedToAnswerCapability","proxyToFrameworks","proxyToFrameworkGenerators","applyProxy","isAutoLoaded","addFramework"],"mappings":"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"}